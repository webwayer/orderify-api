import { Router } from 'express'
import { AlbumType } from 'photoLibrary/_/Album';
import { PhotoType } from 'photoLibrary/_/Photo';
import { storage } from 'pkgcloud'

export function photosRouterFactory(router: Router, Album: AlbumType, Photo: PhotoType, storage: storage.Client) {
    router.get('/', function (req, res) {
        console.log(req.session)
        res.send('Hello World')
    })

    router.get('/albums', async function (req, res) {
        res.json(await Album.findAll({ where: { userId: req.session.userId } }))
    })

    router.get('/photos', async function (req, res) {
        res.json(await Photo.findAll({ where: { userId: req.session.userId } }))
    })

    router.get('/photos/:id/download', async (req, res) => {
        const photo = await Photo.findOne({ where: { userId: req.session.userId, id: (<any>req.params).id } })
        if (photo) {
            storage.download({
                container: 'photos',
                remote: (<any>req.params).id
            }).pipe(res)
        } else {
            res.end()
        }
    })

    return router;
}